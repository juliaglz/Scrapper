<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scraper Voice Assistant</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #9e9ebd;
    color: #1a1a1a;
  }

  h1 {
    text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
  }

  .micro-btn {
    background-color: #2c2c2c;
    border-radius: 50%;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .micro-btn:hover {
    transform: scale(1.2);
    box-shadow: 0 0 15px #00ffff;
  }

  .micro-btn.recording {
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1.1); box-shadow: 0 0 15px #00ffff; }
    50% { transform: scale(1); box-shadow: 0 0 5px #00ffff; }
  }

  input, textarea {
    background-color: #f0f0f5;
    color: #1a1a1a;
    border: 1px solid #ccc;
    padding: 1.5rem 1rem; /* Más altura */
    border-radius: 0.5rem;
    width: 100%;
    max-width: 700px;
    transition: border 0.2s;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #00ffff;
  }

  button {
    background-color: #f0f0f5;
    color: #1a1a1a;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    transition: background-color 0.2s, transform 0.2s;
  }

  button:hover {
    background-color: #e0e0e8;
    transform: scale(1.05);
  }

  .output-box {
    background-color: #f0f0f5;
    border: 1px solid #ccc;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-width: 700px;
    min-height: 4rem; /* más altura */
    color: #555;
  }

  footer {
    font-size: 0.8rem;
    color: #333;
    margin-top: 2rem;
    text-align: center;
  }
</style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

<h1 class="text-4xl mb-6 font-bold">Scraper Assistant</h1>

<div class="flex items-center w-full max-w-xl gap-4 mb-4">
  <input id="instruction" type="text" placeholder="Enter instruction here or use microphone" />
  <button id="record-btn" class="micro-btn">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zm-5 9a7.001 7.001 0 0 0 7-7h-2a5.001 5.001 0 0 1-10 0H5a7.001 7.001 0 0 0 7 7z"/>
    </svg>
  </button>
</div>

<form id="scrape-form" class="flex flex-col w-full max-w-xl gap-4">
  <input id="url" type="text" placeholder="Enter URL to scrape" />
  <button type="submit">Run Scraper</button>
</form>

<div class="w-full max-w-xl mt-4">
  <div id="output-data" class="output-box">Your results will appear here</div>
  <div id="output-code" class="output-box">Your code will be here</div>
</div>

<footer>Created by Julia Gonzalez Ramos</footer>

<script>
const BACKEND_URL = "http://127.0.0.1:8000";
const recordBtn = document.getElementById("record-btn");
const instructionInput = document.getElementById("instruction");
const outputData = document.getElementById("output-data");
const outputCode = document.getElementById("output-code");

let mediaRecorder;
let audioChunks = [];

recordBtn.addEventListener("click", async () => {
  try {
    if (!mediaRecorder || mediaRecorder.state === "inactive") {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      recordBtn.classList.add("recording");

      mediaRecorder.addEventListener("dataavailable", event => {
        audioChunks.push(event.data);
      });

      mediaRecorder.addEventListener("stop", async () => {
        recordBtn.classList.remove("recording");
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("file", audioBlob, "audio.weba");

        try {
          const res = await fetch(`${BACKEND_URL}/stt`, { method: "POST", body: formData });
          if (!res.ok) throw new Error(`STT error: ${res.status}`);
          const data = await res.json();
          instructionInput.value = data.text || "";
        } catch (err) {
          console.error("Could not transcribe audio", err);
          alert("Could not transcribe audio");
        }
      });

      mediaRecorder.start();
    } else if (mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  } catch (err) {
    console.error("Microphone access error:", err);
    alert("Could not access microphone");
  }
});

document.getElementById("scrape-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const url = document.getElementById("url").value.trim();
  const instruction = instructionInput.value.trim();

  if(url || instruction){
    outputData.textContent = "⏳ Running scraper...";
    outputCode.textContent = "⏳ Waiting for code...";
  }

  try {
    const res = await fetch(`${BACKEND_URL}/scrape`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url, instruction })
    });

    if (!res.ok) throw new Error(`Server error: ${res.status}`);
    const { data, code } = await res.json();

    outputData.textContent = JSON.stringify(data, null, 2);
    outputCode.textContent = code;

  } catch (err) {
    outputData.textContent = `❌ Error: ${err.message}`;
    outputCode.textContent = "";
  }
});
</script>
</body>
</html>
